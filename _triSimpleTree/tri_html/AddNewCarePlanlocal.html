            <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Add New Care Plan</title>
    <link href="../tri_css/CarePlanMonitor.css" rel="stylesheet" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
    <link href="../tri_css/kendo.default.min.css" rel="stylesheet" />
    <link href="../tri_css/kendo.common.min.css" rel="stylesheet" />

    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.js"></script>
    <script type="text/javascript" src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>

    <!--<script src="../tri_scripts/jquery_1_12_1min.js"></script>-->
    <script src="../tri_scripts/jquery_ui_192.custom.js"></script>
    <script src="../tri_scripts/kendo.js"></script>
    <script src="../tri_scripts/kendo.all.min.js"></script>
    <script type="text/javascript" src="../tri_scripts/SDK.REST.js"></script>
    <script src="../tri_scripts/json2.js" type="text/javascript"></script>
    <script src="../tri_scripts/linq.min.js"></script>
    <script src="../tri_scripts/linq.js"></script>
    <!----------------------------------------------------------------------------------------->
    <!--<script src="../ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="../tri_scripts/xrmservicetoolkit.js" type="text/javascript"></script>-->
    <script src="../tri_scripts/PatientMonitorMode.js"></script>
    <script src="../tri_scripts/AddNewCarePlan.js"></script>
    <script src="../tri_scripts/CarePlanMon.js"></script>

    <script>
        $(document).ready(function () {
            if (1 == 1) {
                var islocal = true;
                var newPaths = CarePathData;
                var newPlans = CarePlanData;
                //if (parent.Xrm !== undefined) {
                //    var newPaths = GetAllCarePath();
                //    var contactId = parent.Xrm.Page.data.entity.getId();
                //    var newPlans = GetCarePlanfromPatitentId(contactId);

                var selectedCarePath;
                var selectedCarePathId;

                // Get All CarePaths for DropDown
                var ddCarePath = Enumerable.From(newPaths)
                .Select(function (x) { return { 'text': x.attributes.tri_name.value, 'value': x.attributes.tri_cccarepathid.value }; })
                .ToArray();

                // Get All CarePlan to display on Page
                var ddCarePlans = Enumerable.From(newPlans)
                .Select(function (x) { return { 'text': x.attributes.tri_planname.value, 'value': x.attributes.tri_careplanid.id }; })
                .ToArray();

                // Get Distinct CarePlans
                var distinctCarePlansTextArray = Enumerable.From(ddCarePlans)
                                                  .Select(function (x) { return x.text })
                                                  .Distinct(function (y) { return y; })
                                                  .ToArray();

                // Get data to display on dropdown
                // ddCarePath - distinctCarePlans
                var data = ddCarePath.filter(function (x) { return !Enumerable.From(distinctCarePlansTextArray).Contains(x.text); });

                // create DropDownList from input HTML element
                var kendoAutoCompleteWC = $("#carePaths").kendoAutoComplete({
                    dataTextField: "text",
                    dataValueField: "value",
                    filter: "startswith",
                    placeholder: "Viewing All (Select Category)",
                    dataSource: data,
                    index: 0,
                    change: onChange
                }).data("kendoAutoComplete");

                // Display rows from CarePlan
                Enumerable.From(ddCarePlans)
                .Distinct(function (y) { return y.text; })
                .ToArray().forEach(function (arr) { return updateSuccessCallback(arr.text, arr.value, data, kendoAutoCompleteWC); });

                function onChange() {
                    // Get the selected carepath from dropdown
                    selectedCarePath = $('#carePaths').val();
                    var listCarePath = Enumerable.From(data);
                    // Get the selected CarePathId
                    selectedCarePathId = listCarePath
                                         .Where(function (x) { return x.text === selectedCarePath })
                                         .Select(function (x) { return x.value; })
                                         .FirstOrDefault();
                    // Check if the data selcted from datasource <> ''
                    var IsSelectedCarePathfromDataSource = listCarePath
                                                           .Select(function (x) { return x.text; })
                                                           .Contains(selectedCarePath);

                    if (selectedCarePath !== '' && IsSelectedCarePathfromDataSource) {
                        //AddNewCarePlanTemplateData = Enumerable.From(data)
                        //                             // data = Enumerable.From(newPlans)
                        //                             .Where(function (x) { return x.text !== selectedCarePath; })
                        //                             .ToArray();
                        //// create a template using the above definition
                        //var temp = $("#AddNewCarePlanTemplate").html();
                        //var AddNewCarePlanTemplate = kendo.template(temp);
                        //var dataSource = new kendo.data.DataSource({
                        //    data: AddNewCarePlanTemplateData,
                        //    change: function () { // subscribe to the CHANGE event of the data source
                        //        $(".carePlans").html(kendo.render(AddNewCarePlanTemplate, this.view()));
                        //    }
                        //});
                        //dataSource.read();
                        var carePathdataToUpdate = {
                            tri_cccarepathid: { 'value': selectedCarePathId },
                            tri_name: { "value": selectedCarePath }
                        };

                        if (!islocal) {
                            var contact = {};
                            contact.tri_CarePlantoAddID = { Id: selectedCarePathId, LogicalName: "tri_cccarepath", Name: selectedCarePath };
                            SDK.REST.updateRecord(
                                contactId, // Pass Contact ID
                                contact,
                                "Contact",
                                updateSuccessCallback,
                                errorHandler); //  
                            alert("The Patient record changes were saved");
                        }
                        else {
                            // get the newly added CarePlan Data
                            //var addedCarePlan =
                            //    Enumerable.From(GetCarePlanfromPatitentIdandCarePlanName(contactId, selectedCarePath))
                            //    .Select(function (x) { return { 'text': x.attributes.tri_planname.value, 'value': x.attributes.tri_careplanid.id }; })
                            //    .ToArray();
                            // updateSuccessCallback(addedCarePlan.text, addedCarePlan.value, data, kendoAutoCompleteWC);

                            updateSuccessCallback(selectedCarePath, selectedCarePathId, data, kendoAutoCompleteWC);
                        }
                    }
                };

                //$("#window").kendoWindow({
                //    width: "70%",
                //    height: "50%",
                //    //title: "Personalize View",
                //    visible: false,
                //    modal: true,
                //    content: "www.telerik.com",//"personalizepopup.html?CarePathId=1",
                //    actions: [
                //        "Close"
                //    ]
                //}).data("kendoWindow").center().open();

                // function to display Error Message
                function errorHandler(error) {
                    alert(error.message);
                }
                // Function to add CarePlan row
                function updateSuccessCallback(carePlan, carePlanId, data, kendoAutoCompleteWC) {
                    $('#carePlans').append('<div>' +
                                        '<span>' + carePlan + '</span>' +
                                        //'<a onclick="javascript: OpenPersonalizeWindow(); return false;" id="' + carePathId + '" href="">+</a>' +
                                        '<a href="personalizepopup.html?CarePathId=' + carePlanId + '" id="' + carePlanId + '_rowCarePlan">+</a>' +
                                        '</div>');

                    data = Enumerable.From(data)
                                  .Where(function (x) { return x.text !== carePlan; })
                                  .ToArray();
                    // Bind new data to KendAutocomplete
                    kendoAutoCompleteWC.setDataSource(data);
                    $('#carePaths').val('');
                }
            }
        });

    </script>
</head>
<body style="width:80%;">
    <div id="newCarePlan" class="" style="width:100%;margin-left:6%;background-color:#fff;">
        <p style="display:inline-block;width:100%;">
            <a href="stiersolution.html" data-rel="back" class="btnClose">X</a>
        </p>
        <div style="margin-top:-30px;">
            <span style="color: #333333; font-size: 18px; text-align: left;"><h4>Select the Care Plan you want to add:</h4></span>
        </div>
        <div style="margin-top:20px;">
            <div class="dropdown1">
                <input id="carePaths" style="width: 100%" class="dropdown-content1" />
            </div>
            <input type="text" name="searchonAddCarePlan" placeholder="Search for entries" style="float: right; font-style: italic;" />
        </div>
        <div class="clear"></div>
        <div id="updateCarePlan">

        </div>
        <div class="carePlans" id="carePlans" style="margin-top:15px;z-index:-10">
            <!--<script id="AddNewCarePlanTemplate" type="text/x-kendo-template">
                # if(data != ""){  #
                <div style="">
                    <span>#= data.attributes.tri_name.value #</span>
                    <a id="#= data.attributes.tri_cccarepathid.value #" href="\\#">+</a>
                </div>
                #
                }
                #
            </script>-->
        </div>
        <!--<div id="window" style="display: none; padding:30px;margin-left:5%;">
        </div>-->
    </div>
</body>
</html>

